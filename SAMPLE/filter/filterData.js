var sessions=[
  {
    "active": 1,
    "maxPrezente": 20,
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "prezente": 20,
    "sessionCode": "carapace",
    "titlu": "test2",
    "key": "-LX2vwvnUyl133pJTmmc"
  },
  {
    "active": 1,
    "maxPrezente": 30,
    "organizatorName": "Gavrilut",
    "organizatorUID": "uid_gavrilut",
    "prezente": 0,
    "sessionCode": "poo",
    "titlu": "POO",
    "key": "-LX2w77zeX1PrlOPjrRk"
  },
  {
    "active": 1,
    "maxPrezente": 30,
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "prezente": 0,
    "sessionCode": "test7",
    "titlu": "Test7",
    "key": "-LX2wY7G6u90qJP0OjJD"
  },
  {
    "active": 0,
    "maxPrezente": 30,
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "prezente": 0,
    "sessionCode": "test8",
    "titlu": "Test8",
    "key": "-LX2wY7K0eeH8TU-Bl5T"
  },
  {
    "active": 1,
    "maxPrezente": 30,
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "smecher",
        "grade": "12",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "test9",
    "titlu": "Test9",
    "key": "-LX2wY7Oib10hCMsb806"
  },
  {
    "active": 1,
    "maxPrezente": 30,
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "prezente": 0,
    "sessionCode": "test10",
    "titlu": "Test10",
    "key": "-LX2wepkl-NEVwY_Cs8N"
  },
  {
    "active": 1,
    "maxPrezente": 30,
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "prezente": 0,
    "sessionCode": "test11",
    "titlu": "Test11",
    "key": "-LX2wepouY2rSglGHcXA"
  },
  {
    "active": 1,
    "maxPrezente": "5",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "200",
        "grade": "11",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "ioana",
    "titlu": "ioana",
    "key": "-LXGER5aLViZL1xfd9l-"
  },
  {
    "active": 1,
    "maxPrezente": "5",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "200",
        "grade": "11",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "ioana",
    "titlu": "ioana",
    "key": "-LXGESAlhgkfjCC-G7ct"
  },
  {
    "active": 1,
    "maxPrezente": "2",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "200",
        "grade": "11",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "aa",
    "titlu": "aa",
    "key": "-LXGEqi_9kbPldD9Mf9B"
  },
  {
    "active": 1,
    "maxPrezente": "4",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "200",
        "grade": "11",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "aa",
    "titlu": "aa",
    "key": "-LXGFB11O8AUMfYVWx4d"
  },
  {
    "active": 1,
    "maxPrezente": "5",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "zzc",
        "grade": "10",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "aa",
    "titlu": "aa",
    "key": "-LXGFiDvN9I8BLIrFtKO"
  },
  {
    "active": 1,
    "maxPrezente": "20",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "zzc",
        "grade": "10",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "lab3",
    "titlu": "lab 3",
    "key": "-LXGTzU68ZaBj3YdOKlX"
  },
  {
    "active": 1,
    "maxPrezente": "10",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "smec",
        "grade": "12",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "lab4",
    "titlu": "lab4",
    "key": "-LXGgTZP9qxQIDwZQWII"
  },
  {
    "active": 1,
    "maxPrezente": "5",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "sme",
        "grade": "12",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "5",
    "titlu": "lab5",
    "key": "-LXGghE3lfNjS3ekNi5K"
  },
  {
    "active": 1,
    "maxPrezente": "6",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "smec",
        "grade": "12",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "6",
    "titlu": "lab6",
    "key": "-LXGgmI-gnk_ZrcCd5oW"
  },
  {
    "active": 1,
    "maxPrezente": "8",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "smemmm",
        "grade": "12",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "8",
    "titlu": "8",
    "key": "-LXGhoG3lbHId7jq_h_I"
  },
  {
    "active": 1,
    "maxPrezente": "20",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "ia si mai invata",
        "grade": "8",
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan"
      }
    ],
    "prezente": 1,
    "sessionCode": "david",
    "titlu": "lab lui david",
    "key": "-LXKYW3Sn6PJHnnba8zv"
  },
  {
    "active": 1,
    "maxPrezente": "10",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "prezente": 0,
    "sessionCode": "serban",
    "titlu": "serban",
    "key": "-LXQjCGFovwttXB4kd7Y"
  },
  {
    "active": 0,
    "maxPrezente": 20,
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "prezente": 0,
    "sessionCode": "querty",
    "titlu": "mate",
    "key": "-LXolG9rpaDYxA7GttMi"
  },
  {
    "active": 1,
    "maxPrezente": "10",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "participants": [
      {
        "feedback": "Please wait for review",
        "grade": 0,
        "id": "yARRnkFD9KQpeakT4Jth1Vimmur2",
        "name": "cristian stefan",
        "time": 1549224882174
      }
    ],
    "prezente": 1,
    "sessionCode": "lab44",
    "titlu": "lab44",
    "key": "-LXoofujp3p4-towogoP"
  },
  {
    "active": 1,
    "maxPrezente": "",
    "organizatorName": "cosmin stefan",
    "organizatorUID": "dCJ8S4gZk1b9zffvWOHB03qWkKr2",
    "prezente": 0,
    "sessionCode": "5hjKje",
    "titlu": "",
    "key": "-LYE9YNhTIZwOM227B1l"
  }
];

function prepareFilters(iname,_id)
{  
  var avSessions=[];
  var k=-1;
  id=document.getElementById(_id);
  for (var i=0;i<sessions.length;i++)
  {
    if(sessions[i].organizatorName==iname)
    {
      k++;
      avSessions[k]=sessions[i].titlu;
    }
  }
  if(k!=-1)
  {
    for(var j=0;j<=k;j++)
    { 
      addbtn=document.createElement("input");
	    addbtn.type="checkbox";
      addbtn.id=avSessions[j];
      addbtn.className="checkBox";
      paragraf=document.createElement("p")
      paragraf.innerHTML=avSessions[j];
      paragraf.style.width="auto";
      paragraf.style.display="inline-block";
      paragraf.style.marginLeft="20px";
      id.appendChild(paragraf);
      id.appendChild(addbtn);
    }
  }
}



function popUp(){
  prepareFilters("cosmin stefan","availableSessions");
  document.getElementById('createChart').style.display='block';
  
}
function closePopUp(){
  document.getElementById('createChart').style.display='none';
  
}


function getCheckedSessions(){
  var lista=[];
  var result=[];
  var k=-1;
  lista=document.getElementsByClassName("checkBox");
  
  for (var i=0;i<lista.length;i++)
  {
    if(lista[i].checked==true)
    {
      
      k++;
      result[k]=lista[i].id;
    }
  }
  
  return result;
}

function getMarkInterval(){
  var result=[];
  result[1]=document.getElementById("minGrade").value;
  result[2]=document.getElementById("maxGrade").value;
  if((result[1]==null||result[1]=="")&&(result[2]==null||result[2]==""))
    result[0]=1;//used to see which intervals are default
  else
    result[0]=0;
  
  if(result[1]==null||result[1]=="")
    result[1]=0;
  if(result[2]==null||result[2]=="")
    result[2]=20;


  return result;
}

function getTimeInterval(){
  var time=new Date().getTime();
  var result=[];

  result[1]=document.getElementById("startTime").value;
  result[2]=document.getElementById("endTime").value;

  if((result[1]==null||result[1]=="")&&(result[2]==null||result[2]==""))
    result[0]=1;//used to see which intervals are default
  else
    result[0]=0;
  
  if(result[1]==null||result[1]=="")
    result[1]=0;
  if(result[2]==null||result[2]=="")
    result[2]=time;

  return result;
}

function getPassed(){
result= document.getElementById("isPassed");
if(result.checked==true)
  return true;
  else
  return false;
}

function getPredefinedChart(){
  var selection=document.getElementById("predefinedChart");

  return selection.options[selection.selectedIndex].value;
}

function renderChart(_idChart,_titlu,_legend,_data,_labels)
{
	let myChart = document.getElementById('myChart').getContext('2d');

    // Global Options
    Chart.defaults.global.defaultFontFamily = 'Lato';
    Chart.defaults.global.defaultFontSize = 18;
    Chart.defaults.global.defaultFontColor = '#777';

    let massPopChart = new Chart(myChart, {
      type:'bar', // bar, horizontalBar, pie, line, doughnut, radar, polarArea
      data:{
        labels:_labels,
        datasets:[{
          label:_legend,
          data:_data,
          backgroundColor:'rgb(0,134,99)',
          borderWidth:1,
          borderColor:'#777',
          hoverBorderWidth:3,
          hoverBorderColor:'#000'
        }]
      },
      options:{
        title:{
          display:true,
          text:_titlu,
          fontSize:25
        },
        legend:{
          display:true,
          position:'right',
          labels:{
            fontColor:'#000'
          }
        },
        layout:{
          padding:{
            left:50,
            right:0,
            bottom:0,
            top:0
          }
        },
        tooltips:{
          enabled:true
        }
      }
    });
}


function createArraysForChartNothingSelected(sessions){

	rezultat={};
	note=[];
	for (var j=0;j<=15;j++)
		note[j]=0;
	for(var i=0;i<sessions.length;i++)
	{	
		if(sessions[i].participants!=undefined)
		{
		if(sessions[i].participants[0].grade!=0)
		{
			if(sessions[i].participants[0].grade=="0")
			note[0]+=1;
			
			if(sessions[i].participants[0].grade=="1")
			note[1]+=1;
			
			if(sessions[i].participants[0].grade=="2")
			note[2]+=1;
			
			if(sessions[i].participants[0].grade=="3")
			note[3]+=1;
			
			if(sessions[i].participants[0].grade=="4")
			note[4]+=1;
			
			if(sessions[i].participants[0].grade=="5")
			note[5]+=1;
			
			if(sessions[i].participants[0].grade=="6")
			note[6]+=1;
			
			if(sessions[i].participants[0].grade=="7")
			note[7]+=1;
			
			if(sessions[i].participants[0].grade=="8")
			note[8]+=1;
			
			if(sessions[i].participants[0].grade=="9")
			note[9]+=1;
			
			if(sessions[i].participants[0].grade=="10")
			note[10]+=1;
			
			if(sessions[i].participants[0].grade=="11")
			note[11]+=1;
			if(sessions[i].participants[0].grade=="12")
			note[12]+=1;
			if(sessions[i].participants[0].grade=="13")
			note[13]+=1;
			if(sessions[i].participants[0].grade=="14")
			note[14]+=1;
			if(sessions[i].participants[0].grade=="15")
			note[15]+=1;
		}
	}
	}
	rezultat["note"]=note;
	console.log(rezultat);
	
	return rezultat;
}

function  getArrayforFilteredChart(sessions,i_sesiuniMarcate,i_intervalNote,i_intervalTimp,i_trecut_picat)
{
  rezultat={};
  note=[];
  min_nota=0;
  max_nota=20;
  min_timp=0;
  max_timp=new Date().getTime(); 
  if(i_intervalNote[0]==0)
  {
    

    min_nota=i_intervalNote[1];
    max_nota=i_intervalNote[2];
    //filtru pe interval note
  
    
    console.log("interval note in chart:");
    console.log(min_nota);
    console.log(max_nota);
  }
  if(i_trecut_picat==true&&min_nota<5)
    min_nota=5;
    //filtru studenti trecuti
  if(i_intervalTimp[0]==0)
  {
    min_timp=i_intervalTimp[1];
    max_timp=i_intervalTimp[2];
    //filtru timp
  }





  for (var j=0;j<=20;j++)
    note[j]=0;
    
	for(var i=0;i<sessions.length;i++)
	{	
    if(i_sesiuniMarcate.length==0)
		{
      if(sessions[i].participants!=undefined)
		  {
		    if(sessions[i].participants[0].grade!=0)
		    {
          
          console.log(sessions[i].participants[0]);
          if(sessions[i].participants[0].grade>=min_nota&&
            sessions[i].participants[0].grade<=max_nota
            )//trebuie adaugata conditia pentru timp
			      note[sessions[i].participants[0].grade]++;
        }
      }
    }
    else
    {
      console.log("intru aici");
      if(sessions[i].titlu in i_sesiuniMarcate )
      {
        console.log("intru aici");
        if(sessions[i].participants!=undefined)
        {
          if(sessions[i].participants[0].grade!=0)
          {
            if(sessions[i].participants[0].grade>=min_nota&&
              sessions[i].participants[0].grade<=max_nota
              )//trebuie adaugata conditia pentru timp
              note[sessions[i].participants[0].grade]+=1;
          }
        } 
      }
    }
  }
  
  rezultat["note"]=note;
  rezultat["intervalNotaremin"]=min_nota;
  rezultat["intervalNotaremax"]=max_nota;
   
	console.log(rezultat);
	
	return rezultat;

}



async function chart(_predefinedChart,_sesiuniMarcate,_intervalNote,_intervalTimp,_trecut_picat){

  if(_predefinedChart!="SelectValue")
  {
    //predefined charts
  }
  else if(_sesiuniMarcate.length==0&&_intervalNote[0]==1&&_intervalTimp[0]==1&&trecut_picat==false)
  {
	  datas=createArraysForChartNothingSelected(sessions);
	  data=datas.note;
    //data are toate notele ;

    labels=[];
  	for(var i=0;i<=15;i++)
	  	labels[i]=i;
  	titlu="Punctaje";
	  legenda="No of Students"

	  renderChart("myChart",titlu,legenda,data,labels);
  }
  else 
  {
    //All the oder cases!!!
    console.log("Creaza chart unde trebuie");
    datas=getArrayforFilteredChart(sessions,_sesiuniMarcate,_intervalNote,_intervalTimp,_trecut_picat);
    data=datas.note;

    labels=[];
    k=0;
    for(var i=datas.intervalNotaremin;i<=datas.intervalNotaremax;i++)
      labels[k++]=i;
    
    titlu="Punctaje";
    legenda="No of students";

    renderChart("myChart",titlu,legenda,data,labels);
  }
}


async function doit()
{
  var predefinedChart=await getPredefinedChart();
	var sesiuniMarcate=await getCheckedSessions();
  var intervalNote=await getMarkInterval();
  var intervalTimp=await getTimeInterval();
  var trecut_picat=await getPassed();
  console.log("checkboxuri marcate: ");
  console.log(sesiuniMarcate.length);
  console.log("si anume:");
  console.log(sesiuniMarcate);

  console.log("interval note: ");
  console.log(intervalNote[1]);
  console.log(", ");
  console.log(intervalNote[2]);

  
  console.log("interval timp: ");
  console.log(intervalTimp[1]);
  console.log(", ");
  console.log(intervalTimp[2]);

  console.log("afiseaza doar studentii trecuti:");
  console.log(trecut_picat);    

  console.log("predefined:");
  console.log(predefinedChart); //if the value is SelectValue do nothing!!

  chart(predefinedChart,sesiuniMarcate,intervalNote,intervalTimp,trecut_picat);
}
